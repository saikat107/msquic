#
#    ___                   _   _      
#   / _ \                 | | (_)     
#  | |_| | __ _  ___ _ __ | |_ _  ___ 
#  |  _  |/ _` |/ _ \ '_ \| __| |/ __|
#  | | | | (_| |  __/ | | | |_| | (__ 
#  \_| |_/\__, |\___|_| |_|\__|_|\___|
#          __/ |
#  _    _ |___/ 
# | |  | |                / _| |
# | |  | | ___ _ __ _  __| |_| | _____      ____
# | |/\| |/ _ \ '__| |/ /|  _| |/ _ \ \ /\ / / ___|
# \  /\  / (_) | | | | ( | | | | (_) \ V  V /\__ \
#  \/  \/ \___/|_| |_|\_\|_| |_|\___/ \_/\_/ |___/
#
# This file was automatically generated by gh-aw (v0.40.1). DO NOT EDIT.
#
# To update this file, edit the corresponding .md file and run:
#   gh aw compile
# For more information: https://github.com/github/gh-aw/blob/main/.github/aw/github-agentic-workflows.md
#
# Generate tests for PR-changed files targeting 95% coverage (Ubuntu + gcovr)
#
# frontmatter-hash: ff63fdb05aa79ac444d18de4ebf13481ed9b2c89ce204806925687dda8f4ef59

name: "Deeptest Coverage Ubuntu Pr"
"on":
  pull_request:
    branches:
    - master
    types:
    - opened
    - synchronize
    - reopened
    - ready_for_review
  workflow_dispatch:
    inputs:
      agent_name:
        default: DeepTest
        description: Copilot custom agent name
        required: false
        type: string
      arch:
        default: x64
        description: CPU architecture
        required: false
        type: string
      config:
        default: Debug
        description: Build/test configuration (Debug recommended for coverage)
        required: false
        type: string
      coverage_target:
        default: "95"
        description: Target line coverage percentage for the changed C/C++ files
        required: false
        type: string
      exclude_regex:
        default: "(\\.md$|\\.ya?ml$|\\.json$|\\.txt$|^docs/|^submodules/|^src/test/)"
        description: grep -E exclude filter (applied to path list)
        required: false
        type: string
      include_regex:
        default: ^src/
        description: grep -E include filter (applied to path list)
        required: false
        type: string
      max_files:
        default: "10"
        description: Max number of changed files to include
        required: false
        type: string
      max_iterations:
        default: "5"
        description: Max agent iterations to try before stopping
        required: false
        type: string
      pr_number:
        description: Pull request number (required when manually dispatching)
        required: true
        type: string
      tls:
        default: openssl
        description: TLS provider
        required: false
        type: string

permissions: {}

concurrency:
  group: "gh-aw-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}"
  cancel-in-progress: true

run-name: "Deeptest Coverage Ubuntu Pr"

env:
  AGENT_NAME: ${{ github.event.inputs.agent_name || 'DeepTest' }}
  ARCH: ${{ github.event.inputs.arch || 'x64' }}
  CONFIG: ${{ github.event.inputs.config || 'Debug' }}
  COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
  COVERAGE_TARGET: ${{ github.event.inputs.coverage_target || '95' }}
  COVERAGE_XML: artifacts/coverage/gcovr-coverage.xml
  EXCLUDE_REGEX: "${{ github.event.inputs.exclude_regex || '(\\.md$|\\.ya?ml$|\\.json$|\\.txt$|^docs/|^submodules/|^src/test/)' }}"
  GH_TOKEN: ${{ github.token }}
  INCLUDE_REGEX: ${{ github.event.inputs.include_regex || '^src/' }}
  MAX_FILES: ${{ github.event.inputs.max_files || '10' }}
  MAX_ITERATIONS: ${{ github.event.inputs.max_iterations || '5' }}
  PR_NUMBER: ${{ github.event.pull_request.number || github.event.inputs.pr_number }}
  RUN_ID: ${{ github.run_id }}
  TLS: ${{ github.event.inputs.tls || 'openssl' }}

jobs:
  activation:
    needs: pre_activation
    if: >
      (needs.pre_activation.outputs.activated == 'true') && ((github.event_name != 'pull_request') || (github.event.pull_request.head.repo.id == github.repository_id))
    runs-on: ubuntu-slim
    permissions:
      contents: read
    outputs:
      comment_id: ""
      comment_repo: ""
    steps:
      - name: Setup Scripts
        uses: github/gh-aw/actions/setup@17c31ffe96b274cb4a6693638cabf61e45996ee7 # v0.40.1
        with:
          destination: /opt/gh-aw/actions
      - name: Check workflow file timestamps
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          GH_AW_WORKFLOW_FILE: "deeptest-coverage-ubuntu-pr.lock.yml"
        with:
          script: |
            const { setupGlobals } = require('/opt/gh-aw/actions/setup_globals.cjs');
            setupGlobals(core, github, context, exec, io);
            const { main } = require('/opt/gh-aw/actions/check_workflow_timestamp_api.cjs');
            await main();

  agent:
    needs: activation
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read
      pull-requests: read
    env:
      DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
      GH_AW_ASSETS_ALLOWED_EXTS: ""
      GH_AW_ASSETS_BRANCH: ""
      GH_AW_ASSETS_MAX_SIZE_KB: 0
      GH_AW_MCP_LOG_DIR: /tmp/gh-aw/mcp-logs/safeoutputs
      GH_AW_SAFE_OUTPUTS: /opt/gh-aw/safeoutputs/outputs.jsonl
      GH_AW_SAFE_OUTPUTS_CONFIG_PATH: /opt/gh-aw/safeoutputs/config.json
      GH_AW_SAFE_OUTPUTS_TOOLS_PATH: /opt/gh-aw/safeoutputs/tools.json
    outputs:
      checkout_pr_success: ${{ steps.checkout-pr.outputs.checkout_pr_success || 'true' }}
      has_patch: ${{ steps.collect_output.outputs.has_patch }}
      model: ${{ steps.generate_aw_info.outputs.model }}
      output: ${{ steps.collect_output.outputs.output }}
      output_types: ${{ steps.collect_output.outputs.output_types }}
    steps:
      - name: Setup Scripts
        uses: github/gh-aw/actions/setup@17c31ffe96b274cb4a6693638cabf61e45996ee7 # v0.40.1
        with:
          destination: /opt/gh-aw/actions
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          persist-credentials: false
      - name: Setup Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version: '1.25'
      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'
      - name: Create gh-aw temp directory
        run: bash /opt/gh-aw/actions/create_gh_aw_tmp_dir.sh
      - name: Configure Git credentials
        env:
          REPO_NAME: ${{ github.repository }}
          SERVER_URL: ${{ github.server_url }}
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          # Re-authenticate git with GitHub token
          SERVER_URL_STRIPPED="${SERVER_URL#https://}"
          git remote set-url origin "https://x-access-token:${{ github.token }}@${SERVER_URL_STRIPPED}/${REPO_NAME}.git"
          echo "Git configured with standard GitHub Actions identity"
      - name: Checkout PR branch
        id: checkout-pr
        if: |
          github.event.pull_request
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          GH_TOKEN: ${{ secrets.GH_AW_GITHUB_MCP_SERVER_TOKEN || secrets.GH_AW_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
        with:
          github-token: ${{ secrets.GH_AW_GITHUB_MCP_SERVER_TOKEN || secrets.GH_AW_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const { setupGlobals } = require('/opt/gh-aw/actions/setup_globals.cjs');
            setupGlobals(core, github, context, exec, io);
            const { main } = require('/opt/gh-aw/actions/checkout_pr_branch.cjs');
            await main();
      - name: Determine automatic lockdown mode for GitHub MCP server
        id: determine-automatic-lockdown
        env:
          TOKEN_CHECK: ${{ secrets.GH_AW_GITHUB_MCP_SERVER_TOKEN }}
        if: env.TOKEN_CHECK != ''
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const determineAutomaticLockdown = require('/opt/gh-aw/actions/determine_automatic_lockdown.cjs');
            await determineAutomaticLockdown(github, context, core);
      - name: Download container images
        run: bash /opt/gh-aw/actions/download_docker_images.sh ghcr.io/github/gh-aw-mcpg:v0.0.94 ghcr.io/github/github-mcp-server:v0.30.2 node:lts-alpine
      - name: Write Safe Outputs Config
        run: |
          mkdir -p /opt/gh-aw/safeoutputs
          mkdir -p /tmp/gh-aw/safeoutputs
          mkdir -p /tmp/gh-aw/mcp-logs/safeoutputs
          cat > /opt/gh-aw/safeoutputs/config.json << 'EOF'
          {"create_pull_request":{},"missing_data":{},"missing_tool":{},"noop":{"max":1}}
          EOF
          cat > /opt/gh-aw/safeoutputs/tools.json << 'EOF'
          [
            {
              "description": "Create a new GitHub pull request to propose code changes. Use this after making file edits to submit them for review and merging. The PR will be created from the current branch with your committed changes. For code review comments on an existing PR, use create_pull_request_review_comment instead. CONSTRAINTS: Maximum 1 pull request(s) can be created. Title will be prefixed with \"[DeepTest+Coverage Ubuntu Run #${{ github.run_id }}] \". Labels [automation tests] will be automatically added. PRs will be created as drafts.",
              "inputSchema": {
                "additionalProperties": false,
                "properties": {
                  "body": {
                    "description": "Detailed PR description in Markdown. Include what changes were made, why, testing notes, and any breaking changes. Do NOT repeat the title as a heading.",
                    "type": "string"
                  },
                  "branch": {
                    "description": "Source branch name containing the changes. If omitted, uses the current working branch.",
                    "type": "string"
                  },
                  "labels": {
                    "description": "Labels to categorize the PR (e.g., 'enhancement', 'bugfix'). Labels must exist in the repository.",
                    "items": {
                      "type": "string"
                    },
                    "type": "array"
                  },
                  "title": {
                    "description": "Concise PR title describing the changes. Follow repository conventions (e.g., conventional commits). The title appears as the main heading.",
                    "type": "string"
                  }
                },
                "required": [
                  "title",
                  "body"
                ],
                "type": "object"
              },
              "name": "create_pull_request"
            },
            {
              "description": "Report that a tool or capability needed to complete the task is not available, or share any information you deem important about missing functionality or limitations. Use this when you cannot accomplish what was requested because the required functionality is missing or access is restricted.",
              "inputSchema": {
                "additionalProperties": false,
                "properties": {
                  "alternatives": {
                    "description": "Any workarounds, manual steps, or alternative approaches the user could take (max 256 characters).",
                    "type": "string"
                  },
                  "reason": {
                    "description": "Explanation of why this tool is needed or what information you want to share about the limitation (max 256 characters).",
                    "type": "string"
                  },
                  "tool": {
                    "description": "Optional: Name or description of the missing tool or capability (max 128 characters). Be specific about what functionality is needed.",
                    "type": "string"
                  }
                },
                "required": [
                  "reason"
                ],
                "type": "object"
              },
              "name": "missing_tool"
            },
            {
              "description": "Log a transparency message when no significant actions are needed. Use this to confirm workflow completion and provide visibility when analysis is complete but no changes or outputs are required (e.g., 'No issues found', 'All checks passed'). This ensures the workflow produces human-visible output even when no other actions are taken.",
              "inputSchema": {
                "additionalProperties": false,
                "properties": {
                  "message": {
                    "description": "Status or completion message to log. Should explain what was analyzed and the outcome (e.g., 'Code review complete - no issues found', 'Analysis complete - all tests passing').",
                    "type": "string"
                  }
                },
                "required": [
                  "message"
                ],
                "type": "object"
              },
              "name": "noop"
            },
            {
              "description": "Report that data or information needed to complete the task is not available. Use this when you cannot accomplish what was requested because required data, context, or information is missing.",
              "inputSchema": {
                "additionalProperties": false,
                "properties": {
                  "alternatives": {
                    "description": "Any workarounds, manual steps, or alternative approaches the user could take (max 256 characters).",
                    "type": "string"
                  },
                  "context": {
                    "description": "Additional context about the missing data or where it should come from (max 256 characters).",
                    "type": "string"
                  },
                  "data_type": {
                    "description": "Type or description of the missing data or information (max 128 characters). Be specific about what data is needed.",
                    "type": "string"
                  },
                  "reason": {
                    "description": "Explanation of why this data is needed to complete the task (max 256 characters).",
                    "type": "string"
                  }
                },
                "required": [],
                "type": "object"
              },
              "name": "missing_data"
            }
          ]
          EOF
          cat > /opt/gh-aw/safeoutputs/validation.json << 'EOF'
          {
            "create_pull_request": {
              "defaultMax": 1,
              "fields": {
                "body": {
                  "required": true,
                  "type": "string",
                  "sanitize": true,
                  "maxLength": 65000
                },
                "branch": {
                  "required": true,
                  "type": "string",
                  "sanitize": true,
                  "maxLength": 256
                },
                "labels": {
                  "type": "array",
                  "itemType": "string",
                  "itemSanitize": true,
                  "itemMaxLength": 128
                },
                "title": {
                  "required": true,
                  "type": "string",
                  "sanitize": true,
                  "maxLength": 128
                }
              }
            },
            "missing_tool": {
              "defaultMax": 20,
              "fields": {
                "alternatives": {
                  "type": "string",
                  "sanitize": true,
                  "maxLength": 512
                },
                "reason": {
                  "required": true,
                  "type": "string",
                  "sanitize": true,
                  "maxLength": 256
                },
                "tool": {
                  "type": "string",
                  "sanitize": true,
                  "maxLength": 128
                }
              }
            },
            "noop": {
              "defaultMax": 1,
              "fields": {
                "message": {
                  "required": true,
                  "type": "string",
                  "sanitize": true,
                  "maxLength": 65000
                }
              }
            }
          }
          EOF
      - name: Generate Safe Outputs MCP Server Config
        id: safe-outputs-config
        run: |
          # Generate a secure random API key (360 bits of entropy, 40+ chars)
          API_KEY=""
          API_KEY=$(openssl rand -base64 45 | tr -d '/+=')
          PORT=3001
          
          # Register API key as secret to mask it from logs
          echo "::add-mask::${API_KEY}"
          
          # Set outputs for next steps
          {
            echo "safe_outputs_api_key=${API_KEY}"
            echo "safe_outputs_port=${PORT}"
          } >> "$GITHUB_OUTPUT"
          
          echo "Safe Outputs MCP server will run on port ${PORT}"
          
      - name: Start Safe Outputs MCP HTTP Server
        id: safe-outputs-start
        env:
          DEBUG: '*'
          GH_AW_SAFE_OUTPUTS_PORT: ${{ steps.safe-outputs-config.outputs.safe_outputs_port }}
          GH_AW_SAFE_OUTPUTS_API_KEY: ${{ steps.safe-outputs-config.outputs.safe_outputs_api_key }}
          GH_AW_SAFE_OUTPUTS_TOOLS_PATH: /opt/gh-aw/safeoutputs/tools.json
          GH_AW_SAFE_OUTPUTS_CONFIG_PATH: /opt/gh-aw/safeoutputs/config.json
          GH_AW_MCP_LOG_DIR: /tmp/gh-aw/mcp-logs/safeoutputs
        run: |
          # Environment variables are set above to prevent template injection
          export DEBUG
          export GH_AW_SAFE_OUTPUTS_PORT
          export GH_AW_SAFE_OUTPUTS_API_KEY
          export GH_AW_SAFE_OUTPUTS_TOOLS_PATH
          export GH_AW_SAFE_OUTPUTS_CONFIG_PATH
          export GH_AW_MCP_LOG_DIR
          
          bash /opt/gh-aw/actions/start_safe_outputs_server.sh
          
      - name: Start MCP gateway
        id: start-mcp-gateway
        env:
          GH_AW_SAFE_OUTPUTS: ${{ env.GH_AW_SAFE_OUTPUTS }}
          GH_AW_SAFE_OUTPUTS_API_KEY: ${{ steps.safe-outputs-start.outputs.api_key }}
          GH_AW_SAFE_OUTPUTS_PORT: ${{ steps.safe-outputs-start.outputs.port }}
          GITHUB_MCP_LOCKDOWN: ${{ steps.determine-automatic-lockdown.outputs.lockdown == 'true' && '1' || '0' }}
          GITHUB_MCP_SERVER_TOKEN: ${{ secrets.GH_AW_GITHUB_MCP_SERVER_TOKEN || secrets.GH_AW_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          set -eo pipefail
          mkdir -p /tmp/gh-aw/mcp-config
          
          # Export gateway environment variables for MCP config and gateway script
          export MCP_GATEWAY_PORT="80"
          export MCP_GATEWAY_DOMAIN="host.docker.internal"
          MCP_GATEWAY_API_KEY=""
          MCP_GATEWAY_API_KEY=$(openssl rand -base64 45 | tr -d '/+=')
          export MCP_GATEWAY_API_KEY
          export DEBUG="*"
          
          # Register API key as secret to mask it from logs
          echo "::add-mask::${MCP_GATEWAY_API_KEY}"
          export GH_AW_ENGINE="custom"
          export MCP_GATEWAY_DOCKER_COMMAND='docker run -i --rm --network host -v /var/run/docker.sock:/var/run/docker.sock -e MCP_GATEWAY_PORT -e MCP_GATEWAY_DOMAIN -e MCP_GATEWAY_API_KEY -e DEBUG -e MCP_GATEWAY_LOG_DIR -e GH_AW_MCP_LOG_DIR -e GH_AW_SAFE_OUTPUTS -e GH_AW_SAFE_OUTPUTS_CONFIG_PATH -e GH_AW_SAFE_OUTPUTS_TOOLS_PATH -e GH_AW_ASSETS_BRANCH -e GH_AW_ASSETS_MAX_SIZE_KB -e GH_AW_ASSETS_ALLOWED_EXTS -e DEFAULT_BRANCH -e GITHUB_MCP_SERVER_TOKEN -e GITHUB_MCP_LOCKDOWN -e GITHUB_REPOSITORY -e GITHUB_SERVER_URL -e GITHUB_SHA -e GITHUB_WORKSPACE -e GITHUB_TOKEN -e GITHUB_RUN_ID -e GITHUB_RUN_NUMBER -e GITHUB_RUN_ATTEMPT -e GITHUB_JOB -e GITHUB_ACTION -e GITHUB_EVENT_NAME -e GITHUB_EVENT_PATH -e GITHUB_ACTOR -e GITHUB_ACTOR_ID -e GITHUB_TRIGGERING_ACTOR -e GITHUB_WORKFLOW -e GITHUB_WORKFLOW_REF -e GITHUB_WORKFLOW_SHA -e GITHUB_REF -e GITHUB_REF_NAME -e GITHUB_REF_TYPE -e GITHUB_HEAD_REF -e GITHUB_BASE_REF -e GH_AW_SAFE_OUTPUTS_PORT -e GH_AW_SAFE_OUTPUTS_API_KEY -v /opt:/opt:ro -v /tmp:/tmp:rw -v '"${GITHUB_WORKSPACE}"':'"${GITHUB_WORKSPACE}"':rw ghcr.io/github/gh-aw-mcpg:v0.0.94'
          
          cat << MCPCONFIG_EOF | bash /opt/gh-aw/actions/start_mcp_gateway.sh
          {
            "mcpServers": {
              "github": {
                "container": "ghcr.io/github/github-mcp-server:v0.30.2",
                "env": {
                  "GITHUB_LOCKDOWN_MODE": "$GITHUB_MCP_LOCKDOWN",
                  "GITHUB_PERSONAL_ACCESS_TOKEN": "$GITHUB_MCP_SERVER_TOKEN",
                  "GITHUB_READ_ONLY": "1",
                  "GITHUB_TOOLSETS": "context,repos,issues,pull_requests"
                }
              },
              "safeoutputs": {
                "type": "http",
                "url": "http://host.docker.internal:$GH_AW_SAFE_OUTPUTS_PORT",
                "headers": {
                  "Authorization": "$GH_AW_SAFE_OUTPUTS_API_KEY"
                }
              }
            },
            "gateway": {
              "port": $MCP_GATEWAY_PORT,
              "domain": "${MCP_GATEWAY_DOMAIN}",
              "apiKey": "${MCP_GATEWAY_API_KEY}"
            }
          }
          MCPCONFIG_EOF
      - name: Generate agentic run info
        id: generate_aw_info
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const fs = require('fs');
            
            const awInfo = {
              engine_id: "custom",
              engine_name: "Custom Steps",
              model: process.env.GH_AW_MODEL_AGENT_CUSTOM || "",
              version: "",
              agent_version: "",
              cli_version: "v0.40.1",
              workflow_name: "Deeptest Coverage Ubuntu Pr",
              experimental: false,
              supports_tools_allowlist: false,
              supports_http_transport: false,
              run_id: context.runId,
              run_number: context.runNumber,
              run_attempt: process.env.GITHUB_RUN_ATTEMPT,
              repository: context.repo.owner + '/' + context.repo.repo,
              ref: context.ref,
              sha: context.sha,
              actor: context.actor,
              event_name: context.eventName,
              staged: false,
              allowed_domains: ["defaults"],
              firewall_enabled: false,
              awf_version: "",
              awmg_version: "v0.0.94",
              steps: {
                firewall: ""
              },
              created_at: new Date().toISOString()
            };
            
            // Write to /tmp/gh-aw directory to avoid inclusion in PR
            const tmpPath = '/tmp/gh-aw/aw_info.json';
            fs.writeFileSync(tmpPath, JSON.stringify(awInfo, null, 2));
            console.log('Generated aw_info.json at:', tmpPath);
            console.log(JSON.stringify(awInfo, null, 2));
            
            // Set model as output for reuse in other steps/jobs
            core.setOutput('model', awInfo.model);
      - name: Generate workflow overview
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const { generateWorkflowOverview } = require('/opt/gh-aw/actions/generate_workflow_overview.cjs');
            await generateWorkflowOverview(core);
      - name: Create prompt with built-in context
        env:
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
          GH_AW_SAFE_OUTPUTS: ${{ env.GH_AW_SAFE_OUTPUTS }}
          GH_AW_GITHUB_ACTOR: ${{ github.actor }}
          GH_AW_GITHUB_EVENT_COMMENT_ID: ${{ github.event.comment.id }}
          GH_AW_GITHUB_EVENT_DISCUSSION_NUMBER: ${{ github.event.discussion.number }}
          GH_AW_GITHUB_EVENT_ISSUE_NUMBER: ${{ github.event.issue.number }}
          GH_AW_GITHUB_EVENT_PULL_REQUEST_NUMBER: ${{ github.event.pull_request.number }}
          GH_AW_GITHUB_REPOSITORY: ${{ github.repository }}
          GH_AW_GITHUB_RUN_ID: ${{ github.run_id }}
          GH_AW_GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          bash /opt/gh-aw/actions/create_prompt_first.sh
          cat << 'PROMPT_EOF' > "$GH_AW_PROMPT"
          <system>
          PROMPT_EOF
          cat "/opt/gh-aw/prompts/temp_folder_prompt.md" >> "$GH_AW_PROMPT"
          cat "/opt/gh-aw/prompts/markdown.md" >> "$GH_AW_PROMPT"
          cat << 'PROMPT_EOF' >> "$GH_AW_PROMPT"
          <safe-outputs>
          <description>GitHub API Access Instructions</description>
          <important>
          The gh CLI is NOT authenticated. Do NOT use gh commands for GitHub operations.
          </important>
          <instructions>
          To create or modify GitHub resources (issues, discussions, pull requests, etc.), you MUST call the appropriate safe output tool. Simply writing content will NOT work - the workflow requires actual tool calls.
          
          Discover available tools from the safeoutputs MCP server.
          
          **Critical**: Tool calls write structured data that downstream jobs process. Without tool calls, follow-up actions will be skipped.
          
          **Note**: If you made no other safe output tool calls during this workflow execution, call the "noop" tool to provide a status message indicating completion or that no actions were needed.
          </instructions>
          </safe-outputs>
          <github-context>
          The following GitHub context information is available for this workflow:
          {{#if __GH_AW_GITHUB_ACTOR__ }}
          - **actor**: __GH_AW_GITHUB_ACTOR__
          {{/if}}
          {{#if __GH_AW_GITHUB_REPOSITORY__ }}
          - **repository**: __GH_AW_GITHUB_REPOSITORY__
          {{/if}}
          {{#if __GH_AW_GITHUB_WORKSPACE__ }}
          - **workspace**: __GH_AW_GITHUB_WORKSPACE__
          {{/if}}
          {{#if __GH_AW_GITHUB_EVENT_ISSUE_NUMBER__ }}
          - **issue-number**: #__GH_AW_GITHUB_EVENT_ISSUE_NUMBER__
          {{/if}}
          {{#if __GH_AW_GITHUB_EVENT_DISCUSSION_NUMBER__ }}
          - **discussion-number**: #__GH_AW_GITHUB_EVENT_DISCUSSION_NUMBER__
          {{/if}}
          {{#if __GH_AW_GITHUB_EVENT_PULL_REQUEST_NUMBER__ }}
          - **pull-request-number**: #__GH_AW_GITHUB_EVENT_PULL_REQUEST_NUMBER__
          {{/if}}
          {{#if __GH_AW_GITHUB_EVENT_COMMENT_ID__ }}
          - **comment-id**: __GH_AW_GITHUB_EVENT_COMMENT_ID__
          {{/if}}
          {{#if __GH_AW_GITHUB_RUN_ID__ }}
          - **workflow-run-id**: __GH_AW_GITHUB_RUN_ID__
          {{/if}}
          </github-context>
          
          PROMPT_EOF
          cat << 'PROMPT_EOF' >> "$GH_AW_PROMPT"
          </system>
          PROMPT_EOF
          cat << 'PROMPT_EOF' >> "$GH_AW_PROMPT"
          {{#runtime-import workflows/deeptest-coverage-ubuntu-pr.md}}
          PROMPT_EOF
      - name: Substitute placeholders
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
          GH_AW_GITHUB_ACTOR: ${{ github.actor }}
          GH_AW_GITHUB_EVENT_COMMENT_ID: ${{ github.event.comment.id }}
          GH_AW_GITHUB_EVENT_DISCUSSION_NUMBER: ${{ github.event.discussion.number }}
          GH_AW_GITHUB_EVENT_ISSUE_NUMBER: ${{ github.event.issue.number }}
          GH_AW_GITHUB_EVENT_PULL_REQUEST_NUMBER: ${{ github.event.pull_request.number }}
          GH_AW_GITHUB_REPOSITORY: ${{ github.repository }}
          GH_AW_GITHUB_RUN_ID: ${{ github.run_id }}
          GH_AW_GITHUB_WORKSPACE: ${{ github.workspace }}
        with:
          script: |
            const substitutePlaceholders = require('/opt/gh-aw/actions/substitute_placeholders.cjs');
            
            // Call the substitution function
            return await substitutePlaceholders({
              file: process.env.GH_AW_PROMPT,
              substitutions: {
                GH_AW_GITHUB_ACTOR: process.env.GH_AW_GITHUB_ACTOR,
                GH_AW_GITHUB_EVENT_COMMENT_ID: process.env.GH_AW_GITHUB_EVENT_COMMENT_ID,
                GH_AW_GITHUB_EVENT_DISCUSSION_NUMBER: process.env.GH_AW_GITHUB_EVENT_DISCUSSION_NUMBER,
                GH_AW_GITHUB_EVENT_ISSUE_NUMBER: process.env.GH_AW_GITHUB_EVENT_ISSUE_NUMBER,
                GH_AW_GITHUB_EVENT_PULL_REQUEST_NUMBER: process.env.GH_AW_GITHUB_EVENT_PULL_REQUEST_NUMBER,
                GH_AW_GITHUB_REPOSITORY: process.env.GH_AW_GITHUB_REPOSITORY,
                GH_AW_GITHUB_RUN_ID: process.env.GH_AW_GITHUB_RUN_ID,
                GH_AW_GITHUB_WORKSPACE: process.env.GH_AW_GITHUB_WORKSPACE
              }
            });
      - name: Interpolate variables and render templates
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
        with:
          script: |
            const { setupGlobals } = require('/opt/gh-aw/actions/setup_globals.cjs');
            setupGlobals(core, github, context, exec, io);
            const { main } = require('/opt/gh-aw/actions/interpolate_prompt.cjs');
            await main();
      - name: Validate prompt placeholders
        env:
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
        run: bash /opt/gh-aw/actions/validate_prompt_placeholders.sh
      - name: Print prompt
        env:
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
        run: bash /opt/gh-aw/actions/print_prompt_summary.sh
      - name: Fetch PR metadata
        run: |
          set -euo pipefail
          if [ -z "${PR_NUMBER:-}" ]; then
            echo "PR_NUMBER is required" >&2
            exit 1
          fi

          API_URL="${GITHUB_API_URL:-https://api.github.com}"
          pr_json="$(curl -fsSL \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$API_URL/repos/$GITHUB_REPOSITORY/pulls/$PR_NUMBER")"

          head_ref="$(printf '%s' "$pr_json" | jq -r '.head.ref')"
          base_ref="$(printf '%s' "$pr_json" | jq -r '.base.ref')"
          head_sha="$(printf '%s' "$pr_json" | jq -r '.head.sha')"
          base_sha="$(printf '%s' "$pr_json" | jq -r '.base.sha')"
          if [ -z "$head_ref" ] || [ "$head_ref" = "null" ] || [ -z "$base_ref" ] || [ "$base_ref" = "null" ] || \
             [ -z "$head_sha" ] || [ "$head_sha" = "null" ] || [ -z "$base_sha" ] || [ "$base_sha" = "null" ]; then
            echo "Unable to determine PR head/base refs for PR #$PR_NUMBER" >&2
            exit 1
          fi

          echo "PR_HEAD_REF=$head_ref" >> "$GITHUB_ENV"
          echo "PR_BASE_REF=$base_ref" >> "$GITHUB_ENV"
          echo "PR_HEAD_SHA=$head_sha" >> "$GITHUB_ENV"
          echo "PR_BASE_SHA=$base_sha" >> "$GITHUB_ENV"
          echo "PR head ref: $head_ref"
          echo "PR base ref: $base_ref"
          echo "PR head sha: $head_sha"
          echo "PR base sha: $base_sha"
        env:
          GH_AW_MCP_CONFIG: /tmp/gh-aw/mcp-config/mcp-servers.json
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
          GH_AW_SAFE_OUTPUTS: ${{ env.GH_AW_SAFE_OUTPUTS }}
        shell: bash
      - name: Install Copilot CLI
        run: |
          set -euo pipefail
          gh extension install github/gh-copilot || echo "Copilot CLI already installed"
        env:
          GH_AW_MCP_CONFIG: /tmp/gh-aw/mcp-config/mcp-servers.json
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
          GH_AW_SAFE_OUTPUTS: ${{ env.GH_AW_SAFE_OUTPUTS }}
        shell: bash
      - name: Collect changed files from PR (git diff)
        run: |
          set -euo pipefail
          if [ -z "${PR_NUMBER:-}" ]; then
            echo "PR_NUMBER is required" >&2
            exit 1
          fi

          if [ -z "${PR_BASE_SHA:-}" ] || [ -z "${PR_HEAD_SHA:-}" ]; then
            echo "PR_BASE_SHA and PR_HEAD_SHA are required" >&2
            exit 1
          fi

          echo "Computing changed files via git diff (PR base/head SHAs: ${PR_BASE_SHA}...${PR_HEAD_SHA})"
          echo "INCLUDE_REGEX=${INCLUDE_REGEX}"
          echo "EXCLUDE_REGEX=${EXCLUDE_REGEX}"

          # The default Actions checkout is shallow. Triple-dot diff requires a merge-base,
          # which may be missing unless we have enough history.
          if [ "$(git rev-parse --is-shallow-repository 2>/dev/null || echo false)" = "true" ]; then
            echo "Repository is shallow; fetching full history to enable merge-base computation"
            git fetch --no-tags --prune --unshallow origin || true
          fi

          # Ensure both SHAs are present locally.
          git fetch --no-tags --prune origin "${PR_BASE_SHA}" "${PR_HEAD_SHA}" || true

          merge_base="$(git merge-base "${PR_BASE_SHA}" "${PR_HEAD_SHA}" 2>/dev/null || true)"
          if [ -n "$merge_base" ]; then
            echo "Merge base: $merge_base"
            ALL_FILES="$(git diff --name-only --diff-filter=ACMRT "${merge_base}..${PR_HEAD_SHA}" || true)"
          else
            echo "Warning: no merge base found; falling back to two-dot diff (${PR_BASE_SHA}..${PR_HEAD_SHA})"
            ALL_FILES="$(git diff --name-only --diff-filter=ACMRT "${PR_BASE_SHA}..${PR_HEAD_SHA}" || true)"
          fi

          if [ -z "$ALL_FILES" ]; then
            echo "No files returned by git diff for PR #$PR_NUMBER" >&2
            exit 1
          fi

          FILTERED_FILES="$(printf '%s\n' "$ALL_FILES" \
            | grep -E "$INCLUDE_REGEX" \
            | grep -Ev "$EXCLUDE_REGEX" \
            | grep -E '\.(c|cpp|py)$' \
            | head -n "$MAX_FILES" || true)"

          if [ -z "$FILTERED_FILES" ]; then
            echo "No matching .c/.cpp/.py files after filters."
          fi

          printf '%s\n' "$FILTERED_FILES" > /tmp/changed_files.txt

          echo "CHANGED_FILES<<EOF" >> "$GITHUB_ENV"
          cat /tmp/changed_files.txt >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"

          echo "Selected files:"
          cat /tmp/changed_files.txt
        env:
          GH_AW_MCP_CONFIG: /tmp/gh-aw/mcp-config/mcp-servers.json
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
          GH_AW_SAFE_OUTPUTS: ${{ env.GH_AW_SAFE_OUTPUTS }}
        shell: bash
      - name: Prepare build dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y python3-pip gcc g++ jq
          python3 -m pip install --user --upgrade pip
          python3 -m pip install --user gcovr
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
        env:
          GH_AW_MCP_CONFIG: /tmp/gh-aw/mcp-config/mcp-servers.json
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
          GH_AW_SAFE_OUTPUTS: ${{ env.GH_AW_SAFE_OUTPUTS }}
        shell: bash
      - name: Prepare machine (MsQuic)
        run: |
          set -euo pipefail
          pwsh ./scripts/prepare-machine.ps1 -ForBuild -Tls "$TLS"
        env:
          GH_AW_MCP_CONFIG: /tmp/gh-aw/mcp-config/mcp-servers.json
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
          GH_AW_SAFE_OUTPUTS: ${{ env.GH_AW_SAFE_OUTPUTS }}
        shell: bash
      - name: Run DeepTest agent
        run: |
          set -euo pipefail

          if [ -z "${COPILOT_GITHUB_TOKEN:-}" ]; then
            echo "COPILOT_GITHUB_TOKEN secret is required" >&2
            exit 1
          fi

          if [ ! -f /tmp/changed_files.txt ] || [ ! -s /tmp/changed_files.txt ]; then
            echo "No matching .c/.cpp/.py files were selected; skipping DeepTest."
            printf '{"skipped": true, "reason": "no matching .c/.cpp/.py files"}\n' > /tmp/coverage_summary.json
            exit 0
          fi

          CHANGED_FILES_BULLETS="$(sed 's/^/- /' /tmp/changed_files.txt)"

          prompt="You are generating tests for PR #${PR_NUMBER} in ${GITHUB_REPOSITORY}."
          prompt+=$'\n\n'"Coverage target: ${COVERAGE_TARGET}% line coverage on the changed C/C++ files."
          prompt+=$'\n'"Max iterations: ${MAX_ITERATIONS} (stop early once the target is met)."
          prompt+=$'\n\n'"Changed files (filtered .c/.cpp/.py from this PR):"
          prompt+=$'\n'"${CHANGED_FILES_BULLETS}"
          prompt+=$'\n\n'"Build/test/coverage commands (Ubuntu):"
          prompt+=$'\n'"- Build with coverage: CC=gcc CXX=g++ CFLAGS='--coverage -O0 -g' CXXFLAGS='--coverage -O0 -g' LDFLAGS='--coverage' pwsh ./scripts/build.ps1 -Platform linux -Config ${CONFIG} -Arch ${ARCH} -Tls ${TLS} -DisablePerf -DisableTools -CI"
          prompt+=$'\n'"- Run tests: pwsh ./scripts/test.ps1 -Config ${CONFIG} -Arch ${ARCH} -Tls ${TLS} -GHA -LogProfile Full.Light"
          prompt+=$'\n'"- Generate coverage XML: gcovr --root . --object-directory build/linux/${ARCH}_${TLS} --filter '^src/' --exclude '^src/test/' --exclude '^submodules/' --exclude '^src/generated/' --cobertura-pretty --output ${COVERAGE_XML}"
          prompt+=$'\n\n'"Workflow:"
          prompt+=$'\n'"1. Generate or improve tests for the changed files to increase coverage."
          prompt+=$'\n'"2. Build with coverage instrumentation using the commands above."
          prompt+=$'\n'"3. Run the test suite."
          prompt+=$'\n'"4. Generate the Cobertura XML coverage report."
          prompt+=$'\n'"5. Parse the report to compute line coverage for the changed C/C++ files."
          prompt+=$'\n'"6. If coverage < ${COVERAGE_TARGET}%, go back to step 1 and add more tests."
          prompt+=$'\n'"7. Repeat until coverage >= ${COVERAGE_TARGET}% or you have done ${MAX_ITERATIONS} iterations."
          prompt+=$'\n\n'"Constraints:"
          prompt+=$'\n'"- Prefer adding tests under src/test/. Avoid changing production code unless required for testability."
          prompt+=$'\n'"- Keep tests deterministic; avoid flaky timing-dependent assertions."
          prompt+=$'\n'"- Do NOT create a PR, do NOT run 'gh pr create', do NOT push branches. The workflow will handle PR creation after you finish."
          prompt+=$'\n'"- After each coverage measurement, write a JSON summary to /tmp/coverage_summary.json with at least: {target, totals: {lines_valid, lines_covered, coverage_percent}, files: [{path, coverage_percent}]}."
          prompt+=$'\n\n'
          if [ -f .github/agentics/deeptest-coverage-ubuntu-pr.md ]; then
            prompt+="$(cat .github/agentics/deeptest-coverage-ubuntu-pr.md)"
          fi

          echo "Invoking ${AGENT_NAME} with ${COVERAGE_TARGET}% target for changed files"
          gh copilot --agent "$AGENT_NAME" --allow-all-tools -p "$prompt"
        env:
          GH_AW_MCP_CONFIG: /tmp/gh-aw/mcp-config/mcp-servers.json
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
          GH_AW_SAFE_OUTPUTS: ${{ env.GH_AW_SAFE_OUTPUTS }}
        shell: bash
      - name: Request PR creation via safe output
        run: |
          set -euo pipefail

          if [ -z "${COPILOT_GITHUB_TOKEN:-}" ]; then
            echo "COPILOT_GITHUB_TOKEN secret is required" >&2
            exit 1
          fi

          if ! git status --porcelain | grep -q .; then
            echo "No changes detected; requesting noop safe output."
            prompt="There are no file changes to commit. Please call the noop safe output tool with message: 'No test changes were generated for PR #${PR_NUMBER}.'"
            gh copilot --agent "$AGENT_NAME" --allow-all-tools -p "$prompt"
            exit 0
          fi

          title="[DeepTest+Coverage Ubuntu Run #${RUN_ID}] Add tests for coverage"
          changed_list="$(sed 's/^/- /' /tmp/changed_files.txt 2>/dev/null || echo '(none)')"
          coverage_info="$(cat /tmp/coverage_summary.json 2>/dev/null || echo 'Coverage summary not available.')"
          body="Generated/updated tests for PR #${PR_NUMBER}.\n\nChanged files considered:\n${changed_list}\n\nCoverage summary:\n${coverage_info}"

          prompt="IMPORTANT: You MUST use the 'create_pull_request' safe output tool to create a pull request. Do NOT use 'gh pr create' or 'git push' or any direct GitHub CLI commands.\n\nCall the create_pull_request safe output tool with these parameters:\n- title: ${title}\n- body: ${body}\n\nThis is a workflow safe output â€” the infrastructure will handle the actual PR creation."
          gh copilot --agent "$AGENT_NAME" --allow-all-tools -p "$prompt"
        env:
          GH_AW_MCP_CONFIG: /tmp/gh-aw/mcp-config/mcp-servers.json
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
          GH_AW_SAFE_OUTPUTS: ${{ env.GH_AW_SAFE_OUTPUTS }}
        shell: bash
      - name: Upload coverage artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        env:
          GH_AW_MCP_CONFIG: /tmp/gh-aw/mcp-config/mcp-servers.json
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
          GH_AW_SAFE_OUTPUTS: ${{ env.GH_AW_SAFE_OUTPUTS }}
        with:
          name: ubuntu-gcovr-coverage
          path: |
            artifacts/coverage/*
            artifacts/TestResults/**
            artifacts/logs/**
            /tmp/changed_files.txt
            /tmp/coverage_summary.json
      - name: Ensure log file exists
        run: |
          echo "Custom steps execution completed" >> /tmp/gh-aw/agent-stdio.log
          touch /tmp/gh-aw/agent-stdio.log
      - name: Stop MCP gateway
        if: always()
        continue-on-error: true
        env:
          MCP_GATEWAY_PORT: ${{ steps.start-mcp-gateway.outputs.gateway-port }}
          MCP_GATEWAY_API_KEY: ${{ steps.start-mcp-gateway.outputs.gateway-api-key }}
          GATEWAY_PID: ${{ steps.start-mcp-gateway.outputs.gateway-pid }}
        run: |
          bash /opt/gh-aw/actions/stop_mcp_gateway.sh "$GATEWAY_PID"
      - name: Redact secrets in logs
        if: always()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const { setupGlobals } = require('/opt/gh-aw/actions/setup_globals.cjs');
            setupGlobals(core, github, context, exec, io);
            const { main } = require('/opt/gh-aw/actions/redact_secrets.cjs');
            await main();
        env:
          GH_AW_SECRET_NAMES: 'GH_AW_GITHUB_MCP_SERVER_TOKEN,GH_AW_GITHUB_TOKEN,GITHUB_TOKEN'
          SECRET_GH_AW_GITHUB_MCP_SERVER_TOKEN: ${{ secrets.GH_AW_GITHUB_MCP_SERVER_TOKEN }}
          SECRET_GH_AW_GITHUB_TOKEN: ${{ secrets.GH_AW_GITHUB_TOKEN }}
          SECRET_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload Safe Outputs
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: safe-output
          path: ${{ env.GH_AW_SAFE_OUTPUTS }}
          if-no-files-found: warn
      - name: Ingest agent output
        id: collect_output
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          GH_AW_SAFE_OUTPUTS: ${{ env.GH_AW_SAFE_OUTPUTS }}
          GH_AW_ALLOWED_DOMAINS: "api.snapcraft.io,archive.ubuntu.com,azure.archive.ubuntu.com,crl.geotrust.com,crl.globalsign.com,crl.identrust.com,crl.sectigo.com,crl.thawte.com,crl.usertrust.com,crl.verisign.com,crl3.digicert.com,crl4.digicert.com,crls.ssl.com,json-schema.org,json.schemastore.org,keyserver.ubuntu.com,ocsp.digicert.com,ocsp.geotrust.com,ocsp.globalsign.com,ocsp.identrust.com,ocsp.sectigo.com,ocsp.ssl.com,ocsp.thawte.com,ocsp.usertrust.com,ocsp.verisign.com,packagecloud.io,packages.cloud.google.com,packages.microsoft.com,ppa.launchpad.net,s.symcb.com,s.symcd.com,security.ubuntu.com,ts-crl.ws.symantec.com,ts-ocsp.ws.symantec.com"
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_API_URL: ${{ github.api_url }}
        with:
          script: |
            const { setupGlobals } = require('/opt/gh-aw/actions/setup_globals.cjs');
            setupGlobals(core, github, context, exec, io);
            const { main } = require('/opt/gh-aw/actions/collect_ndjson_output.cjs');
            await main();
      - name: Upload sanitized agent output
        if: always() && env.GH_AW_AGENT_OUTPUT
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: agent-output
          path: ${{ env.GH_AW_AGENT_OUTPUT }}
          if-no-files-found: warn
      - name: Parse agent logs for step summary
        if: always()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          GH_AW_AGENT_OUTPUT: /tmp/gh-aw/agent-stdio.log
        with:
          script: |
            const { setupGlobals } = require('/opt/gh-aw/actions/setup_globals.cjs');
            setupGlobals(core, github, context, exec, io);
            const { main } = require('/opt/gh-aw/actions/parse_custom_log.cjs');
            await main();
      - name: Parse MCP gateway logs for step summary
        if: always()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const { setupGlobals } = require('/opt/gh-aw/actions/setup_globals.cjs');
            setupGlobals(core, github, context, exec, io);
            const { main } = require('/opt/gh-aw/actions/parse_mcp_gateway_log.cjs');
            await main();
      - name: Upload agent artifacts
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: agent-artifacts
          path: |
            /tmp/gh-aw/aw-prompts/prompt.txt
            /tmp/gh-aw/aw_info.json
            /tmp/gh-aw/mcp-logs/
            /tmp/gh-aw/agent-stdio.log
            /tmp/gh-aw/aw.patch
          if-no-files-found: ignore

  conclusion:
    needs:
      - activation
      - agent
      - detection
      - safe_outputs
    if: (always()) && (needs.agent.result != 'skipped')
    runs-on: ubuntu-slim
    permissions:
      contents: read
      discussions: write
      issues: write
      pull-requests: write
    outputs:
      noop_message: ${{ steps.noop.outputs.noop_message }}
      tools_reported: ${{ steps.missing_tool.outputs.tools_reported }}
      total_count: ${{ steps.missing_tool.outputs.total_count }}
    steps:
      - name: Setup Scripts
        uses: github/gh-aw/actions/setup@17c31ffe96b274cb4a6693638cabf61e45996ee7 # v0.40.1
        with:
          destination: /opt/gh-aw/actions
      - name: Debug job inputs
        env:
          COMMENT_ID: ${{ needs.activation.outputs.comment_id }}
          COMMENT_REPO: ${{ needs.activation.outputs.comment_repo }}
          AGENT_OUTPUT_TYPES: ${{ needs.agent.outputs.output_types }}
          AGENT_CONCLUSION: ${{ needs.agent.result }}
        run: |
          echo "Comment ID: $COMMENT_ID"
          echo "Comment Repo: $COMMENT_REPO"
          echo "Agent Output Types: $AGENT_OUTPUT_TYPES"
          echo "Agent Conclusion: $AGENT_CONCLUSION"
      - name: Download agent output artifact
        continue-on-error: true
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: agent-output
          path: /tmp/gh-aw/safeoutputs/
      - name: Setup agent output environment variable
        run: |
          mkdir -p /tmp/gh-aw/safeoutputs/
          find "/tmp/gh-aw/safeoutputs/" -type f -print
          echo "GH_AW_AGENT_OUTPUT=/tmp/gh-aw/safeoutputs/agent_output.json" >> "$GITHUB_ENV"
      - name: Process No-Op Messages
        id: noop
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          GH_AW_AGENT_OUTPUT: ${{ env.GH_AW_AGENT_OUTPUT }}
          GH_AW_NOOP_MAX: 1
          GH_AW_WORKFLOW_NAME: "Deeptest Coverage Ubuntu Pr"
        with:
          github-token: ${{ secrets.GH_AW_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const { setupGlobals } = require('/opt/gh-aw/actions/setup_globals.cjs');
            setupGlobals(core, github, context, exec, io);
            const { main } = require('/opt/gh-aw/actions/noop.cjs');
            await main();
      - name: Record Missing Tool
        id: missing_tool
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          GH_AW_AGENT_OUTPUT: ${{ env.GH_AW_AGENT_OUTPUT }}
          GH_AW_WORKFLOW_NAME: "Deeptest Coverage Ubuntu Pr"
        with:
          github-token: ${{ secrets.GH_AW_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const { setupGlobals } = require('/opt/gh-aw/actions/setup_globals.cjs');
            setupGlobals(core, github, context, exec, io);
            const { main } = require('/opt/gh-aw/actions/missing_tool.cjs');
            await main();
      - name: Handle Agent Failure
        id: handle_agent_failure
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          GH_AW_AGENT_OUTPUT: ${{ env.GH_AW_AGENT_OUTPUT }}
          GH_AW_WORKFLOW_NAME: "Deeptest Coverage Ubuntu Pr"
          GH_AW_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          GH_AW_AGENT_CONCLUSION: ${{ needs.agent.result }}
          GH_AW_CHECKOUT_PR_SUCCESS: ${{ needs.agent.outputs.checkout_pr_success }}
        with:
          github-token: ${{ secrets.GH_AW_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const { setupGlobals } = require('/opt/gh-aw/actions/setup_globals.cjs');
            setupGlobals(core, github, context, exec, io);
            const { main } = require('/opt/gh-aw/actions/handle_agent_failure.cjs');
            await main();
      - name: Handle Create Pull Request Error
        id: handle_create_pr_error
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          GH_AW_AGENT_OUTPUT: ${{ env.GH_AW_AGENT_OUTPUT }}
          GH_AW_WORKFLOW_NAME: "Deeptest Coverage Ubuntu Pr"
          GH_AW_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          github-token: ${{ secrets.GH_AW_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const { setupGlobals } = require('/opt/gh-aw/actions/setup_globals.cjs');
            setupGlobals(core, github, context, exec, io);
            const { main } = require('/opt/gh-aw/actions/handle_create_pr_error.cjs');
            await main();
      - name: Update reaction comment with completion status
        id: conclusion
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          GH_AW_AGENT_OUTPUT: ${{ env.GH_AW_AGENT_OUTPUT }}
          GH_AW_COMMENT_ID: ${{ needs.activation.outputs.comment_id }}
          GH_AW_COMMENT_REPO: ${{ needs.activation.outputs.comment_repo }}
          GH_AW_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          GH_AW_WORKFLOW_NAME: "Deeptest Coverage Ubuntu Pr"
          GH_AW_AGENT_CONCLUSION: ${{ needs.agent.result }}
          GH_AW_DETECTION_CONCLUSION: ${{ needs.detection.result }}
        with:
          github-token: ${{ secrets.GH_AW_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const { setupGlobals } = require('/opt/gh-aw/actions/setup_globals.cjs');
            setupGlobals(core, github, context, exec, io);
            const { main } = require('/opt/gh-aw/actions/notify_comment_error.cjs');
            await main();

  detection:
    needs: agent
    if: needs.agent.outputs.output_types != '' || needs.agent.outputs.has_patch == 'true'
    runs-on: ubuntu-latest
    permissions: {}
    timeout-minutes: 10
    outputs:
      success: ${{ steps.parse_results.outputs.success }}
    steps:
      - name: Setup Scripts
        uses: github/gh-aw/actions/setup@17c31ffe96b274cb4a6693638cabf61e45996ee7 # v0.40.1
        with:
          destination: /opt/gh-aw/actions
      - name: Download agent artifacts
        continue-on-error: true
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: agent-artifacts
          path: /tmp/gh-aw/threat-detection/
      - name: Download agent output artifact
        continue-on-error: true
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: agent-output
          path: /tmp/gh-aw/threat-detection/
      - name: Echo agent output types
        env:
          AGENT_OUTPUT_TYPES: ${{ needs.agent.outputs.output_types }}
        run: |
          echo "Agent output-types: $AGENT_OUTPUT_TYPES"
      - name: Setup threat detection
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          WORKFLOW_NAME: "Deeptest Coverage Ubuntu Pr"
          WORKFLOW_DESCRIPTION: "Generate tests for PR-changed files targeting 95% coverage (Ubuntu + gcovr)"
          HAS_PATCH: ${{ needs.agent.outputs.has_patch }}
        with:
          script: |
            const { setupGlobals } = require('/opt/gh-aw/actions/setup_globals.cjs');
            setupGlobals(core, github, context, exec, io);
            const { main } = require('/opt/gh-aw/actions/setup_threat_detection.cjs');
            await main();
      - name: Ensure threat-detection directory and log
        run: |
          mkdir -p /tmp/gh-aw/threat-detection
          touch /tmp/gh-aw/threat-detection/detection.log
      - name: Fetch PR metadata
        run: |
          set -euo pipefail
          if [ -z "${PR_NUMBER:-}" ]; then
            echo "PR_NUMBER is required" >&2
            exit 1
          fi

          API_URL="${GITHUB_API_URL:-https://api.github.com}"
          pr_json="$(curl -fsSL \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$API_URL/repos/$GITHUB_REPOSITORY/pulls/$PR_NUMBER")"

          head_ref="$(printf '%s' "$pr_json" | jq -r '.head.ref')"
          base_ref="$(printf '%s' "$pr_json" | jq -r '.base.ref')"
          head_sha="$(printf '%s' "$pr_json" | jq -r '.head.sha')"
          base_sha="$(printf '%s' "$pr_json" | jq -r '.base.sha')"
          if [ -z "$head_ref" ] || [ "$head_ref" = "null" ] || [ -z "$base_ref" ] || [ "$base_ref" = "null" ] || \
             [ -z "$head_sha" ] || [ "$head_sha" = "null" ] || [ -z "$base_sha" ] || [ "$base_sha" = "null" ]; then
            echo "Unable to determine PR head/base refs for PR #$PR_NUMBER" >&2
            exit 1
          fi

          echo "PR_HEAD_REF=$head_ref" >> "$GITHUB_ENV"
          echo "PR_BASE_REF=$base_ref" >> "$GITHUB_ENV"
          echo "PR_HEAD_SHA=$head_sha" >> "$GITHUB_ENV"
          echo "PR_BASE_SHA=$base_sha" >> "$GITHUB_ENV"
          echo "PR head ref: $head_ref"
          echo "PR base ref: $base_ref"
          echo "PR head sha: $head_sha"
          echo "PR base sha: $base_sha"
        env:
          GH_AW_MCP_CONFIG: /tmp/gh-aw/mcp-config/mcp-servers.json
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
        shell: bash
      - name: Install Copilot CLI
        run: |
          set -euo pipefail
          gh extension install github/gh-copilot || echo "Copilot CLI already installed"
        env:
          GH_AW_MCP_CONFIG: /tmp/gh-aw/mcp-config/mcp-servers.json
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
        shell: bash
      - name: Collect changed files from PR (git diff)
        run: |
          set -euo pipefail
          if [ -z "${PR_NUMBER:-}" ]; then
            echo "PR_NUMBER is required" >&2
            exit 1
          fi

          if [ -z "${PR_BASE_SHA:-}" ] || [ -z "${PR_HEAD_SHA:-}" ]; then
            echo "PR_BASE_SHA and PR_HEAD_SHA are required" >&2
            exit 1
          fi

          echo "Computing changed files via git diff (PR base/head SHAs: ${PR_BASE_SHA}...${PR_HEAD_SHA})"
          echo "INCLUDE_REGEX=${INCLUDE_REGEX}"
          echo "EXCLUDE_REGEX=${EXCLUDE_REGEX}"

          # The default Actions checkout is shallow. Triple-dot diff requires a merge-base,
          # which may be missing unless we have enough history.
          if [ "$(git rev-parse --is-shallow-repository 2>/dev/null || echo false)" = "true" ]; then
            echo "Repository is shallow; fetching full history to enable merge-base computation"
            git fetch --no-tags --prune --unshallow origin || true
          fi

          # Ensure both SHAs are present locally.
          git fetch --no-tags --prune origin "${PR_BASE_SHA}" "${PR_HEAD_SHA}" || true

          merge_base="$(git merge-base "${PR_BASE_SHA}" "${PR_HEAD_SHA}" 2>/dev/null || true)"
          if [ -n "$merge_base" ]; then
            echo "Merge base: $merge_base"
            ALL_FILES="$(git diff --name-only --diff-filter=ACMRT "${merge_base}..${PR_HEAD_SHA}" || true)"
          else
            echo "Warning: no merge base found; falling back to two-dot diff (${PR_BASE_SHA}..${PR_HEAD_SHA})"
            ALL_FILES="$(git diff --name-only --diff-filter=ACMRT "${PR_BASE_SHA}..${PR_HEAD_SHA}" || true)"
          fi

          if [ -z "$ALL_FILES" ]; then
            echo "No files returned by git diff for PR #$PR_NUMBER" >&2
            exit 1
          fi

          FILTERED_FILES="$(printf '%s\n' "$ALL_FILES" \
            | grep -E "$INCLUDE_REGEX" \
            | grep -Ev "$EXCLUDE_REGEX" \
            | grep -E '\.(c|cpp|py)$' \
            | head -n "$MAX_FILES" || true)"

          if [ -z "$FILTERED_FILES" ]; then
            echo "No matching .c/.cpp/.py files after filters."
          fi

          printf '%s\n' "$FILTERED_FILES" > /tmp/changed_files.txt

          echo "CHANGED_FILES<<EOF" >> "$GITHUB_ENV"
          cat /tmp/changed_files.txt >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"

          echo "Selected files:"
          cat /tmp/changed_files.txt
        env:
          GH_AW_MCP_CONFIG: /tmp/gh-aw/mcp-config/mcp-servers.json
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
        shell: bash
      - name: Prepare build dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y python3-pip gcc g++ jq
          python3 -m pip install --user --upgrade pip
          python3 -m pip install --user gcovr
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
        env:
          GH_AW_MCP_CONFIG: /tmp/gh-aw/mcp-config/mcp-servers.json
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
        shell: bash
      - name: Prepare machine (MsQuic)
        run: |
          set -euo pipefail
          pwsh ./scripts/prepare-machine.ps1 -ForBuild -Tls "$TLS"
        env:
          GH_AW_MCP_CONFIG: /tmp/gh-aw/mcp-config/mcp-servers.json
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
        shell: bash
      - name: Run DeepTest agent
        run: |
          set -euo pipefail

          if [ -z "${COPILOT_GITHUB_TOKEN:-}" ]; then
            echo "COPILOT_GITHUB_TOKEN secret is required" >&2
            exit 1
          fi

          if [ ! -f /tmp/changed_files.txt ] || [ ! -s /tmp/changed_files.txt ]; then
            echo "No matching .c/.cpp/.py files were selected; skipping DeepTest."
            printf '{"skipped": true, "reason": "no matching .c/.cpp/.py files"}\n' > /tmp/coverage_summary.json
            exit 0
          fi

          CHANGED_FILES_BULLETS="$(sed 's/^/- /' /tmp/changed_files.txt)"

          prompt="You are generating tests for PR #${PR_NUMBER} in ${GITHUB_REPOSITORY}."
          prompt+=$'\n\n'"Coverage target: ${COVERAGE_TARGET}% line coverage on the changed C/C++ files."
          prompt+=$'\n'"Max iterations: ${MAX_ITERATIONS} (stop early once the target is met)."
          prompt+=$'\n\n'"Changed files (filtered .c/.cpp/.py from this PR):"
          prompt+=$'\n'"${CHANGED_FILES_BULLETS}"
          prompt+=$'\n\n'"Build/test/coverage commands (Ubuntu):"
          prompt+=$'\n'"- Build with coverage: CC=gcc CXX=g++ CFLAGS='--coverage -O0 -g' CXXFLAGS='--coverage -O0 -g' LDFLAGS='--coverage' pwsh ./scripts/build.ps1 -Platform linux -Config ${CONFIG} -Arch ${ARCH} -Tls ${TLS} -DisablePerf -DisableTools -CI"
          prompt+=$'\n'"- Run tests: pwsh ./scripts/test.ps1 -Config ${CONFIG} -Arch ${ARCH} -Tls ${TLS} -GHA -LogProfile Full.Light"
          prompt+=$'\n'"- Generate coverage XML: gcovr --root . --object-directory build/linux/${ARCH}_${TLS} --filter '^src/' --exclude '^src/test/' --exclude '^submodules/' --exclude '^src/generated/' --cobertura-pretty --output ${COVERAGE_XML}"
          prompt+=$'\n\n'"Workflow:"
          prompt+=$'\n'"1. Generate or improve tests for the changed files to increase coverage."
          prompt+=$'\n'"2. Build with coverage instrumentation using the commands above."
          prompt+=$'\n'"3. Run the test suite."
          prompt+=$'\n'"4. Generate the Cobertura XML coverage report."
          prompt+=$'\n'"5. Parse the report to compute line coverage for the changed C/C++ files."
          prompt+=$'\n'"6. If coverage < ${COVERAGE_TARGET}%, go back to step 1 and add more tests."
          prompt+=$'\n'"7. Repeat until coverage >= ${COVERAGE_TARGET}% or you have done ${MAX_ITERATIONS} iterations."
          prompt+=$'\n\n'"Constraints:"
          prompt+=$'\n'"- Prefer adding tests under src/test/. Avoid changing production code unless required for testability."
          prompt+=$'\n'"- Keep tests deterministic; avoid flaky timing-dependent assertions."
          prompt+=$'\n'"- Do NOT create a PR, do NOT run 'gh pr create', do NOT push branches. The workflow will handle PR creation after you finish."
          prompt+=$'\n'"- After each coverage measurement, write a JSON summary to /tmp/coverage_summary.json with at least: {target, totals: {lines_valid, lines_covered, coverage_percent}, files: [{path, coverage_percent}]}."
          prompt+=$'\n\n'
          if [ -f .github/agentics/deeptest-coverage-ubuntu-pr.md ]; then
            prompt+="$(cat .github/agentics/deeptest-coverage-ubuntu-pr.md)"
          fi

          echo "Invoking ${AGENT_NAME} with ${COVERAGE_TARGET}% target for changed files"
          gh copilot --agent "$AGENT_NAME" --allow-all-tools -p "$prompt"
        env:
          GH_AW_MCP_CONFIG: /tmp/gh-aw/mcp-config/mcp-servers.json
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
        shell: bash
      - name: Request PR creation via safe output
        run: |
          set -euo pipefail

          if [ -z "${COPILOT_GITHUB_TOKEN:-}" ]; then
            echo "COPILOT_GITHUB_TOKEN secret is required" >&2
            exit 1
          fi

          if ! git status --porcelain | grep -q .; then
            echo "No changes detected; requesting noop safe output."
            prompt="There are no file changes to commit. Please call the noop safe output tool with message: 'No test changes were generated for PR #${PR_NUMBER}.'"
            gh copilot --agent "$AGENT_NAME" --allow-all-tools -p "$prompt"
            exit 0
          fi

          title="[DeepTest+Coverage Ubuntu Run #${RUN_ID}] Add tests for coverage"
          changed_list="$(sed 's/^/- /' /tmp/changed_files.txt 2>/dev/null || echo '(none)')"
          coverage_info="$(cat /tmp/coverage_summary.json 2>/dev/null || echo 'Coverage summary not available.')"
          body="Generated/updated tests for PR #${PR_NUMBER}.\n\nChanged files considered:\n${changed_list}\n\nCoverage summary:\n${coverage_info}"

          prompt="IMPORTANT: You MUST use the 'create_pull_request' safe output tool to create a pull request. Do NOT use 'gh pr create' or 'git push' or any direct GitHub CLI commands.\n\nCall the create_pull_request safe output tool with these parameters:\n- title: ${title}\n- body: ${body}\n\nThis is a workflow safe output â€” the infrastructure will handle the actual PR creation."
          gh copilot --agent "$AGENT_NAME" --allow-all-tools -p "$prompt"
        env:
          GH_AW_MCP_CONFIG: /tmp/gh-aw/mcp-config/mcp-servers.json
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
        shell: bash
      - name: Upload coverage artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        env:
          GH_AW_MCP_CONFIG: /tmp/gh-aw/mcp-config/mcp-servers.json
          GH_AW_PROMPT: /tmp/gh-aw/aw-prompts/prompt.txt
        with:
          name: ubuntu-gcovr-coverage
          path: |
            artifacts/coverage/*
            artifacts/TestResults/**
            artifacts/logs/**
            /tmp/changed_files.txt
            /tmp/coverage_summary.json
      - name: Ensure log file exists
        run: |
          echo "Custom steps execution completed" >> /tmp/gh-aw/threat-detection/detection.log
          touch /tmp/gh-aw/threat-detection/detection.log
      - name: Parse threat detection results
        id: parse_results
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const { setupGlobals } = require('/opt/gh-aw/actions/setup_globals.cjs');
            setupGlobals(core, github, context, exec, io);
            const { main } = require('/opt/gh-aw/actions/parse_threat_detection_results.cjs');
            await main();
      - name: Upload threat detection log
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: threat-detection.log
          path: /tmp/gh-aw/threat-detection/detection.log
          if-no-files-found: ignore

  pre_activation:
    if: (github.event_name != 'pull_request') || (github.event.pull_request.head.repo.id == github.repository_id)
    runs-on: ubuntu-slim
    outputs:
      activated: ${{ steps.check_membership.outputs.is_team_member == 'true' }}
    steps:
      - name: Setup Scripts
        uses: github/gh-aw/actions/setup@17c31ffe96b274cb4a6693638cabf61e45996ee7 # v0.40.1
        with:
          destination: /opt/gh-aw/actions
      - name: Check team membership for workflow
        id: check_membership
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          GH_AW_REQUIRED_ROLES: admin,maintainer,write
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { setupGlobals } = require('/opt/gh-aw/actions/setup_globals.cjs');
            setupGlobals(core, github, context, exec, io);
            const { main } = require('/opt/gh-aw/actions/check_membership.cjs');
            await main();

  safe_outputs:
    needs:
      - activation
      - agent
      - detection
    if: ((!cancelled()) && (needs.agent.result != 'skipped')) && (needs.detection.outputs.success == 'true')
    runs-on: ubuntu-slim
    permissions:
      contents: write
      issues: write
      pull-requests: write
    timeout-minutes: 15
    env:
      GH_AW_ENGINE_ID: "custom"
      GH_AW_WORKFLOW_ID: "deeptest-coverage-ubuntu-pr"
      GH_AW_WORKFLOW_NAME: "Deeptest Coverage Ubuntu Pr"
    outputs:
      create_discussion_error_count: ${{ steps.process_safe_outputs.outputs.create_discussion_error_count }}
      create_discussion_errors: ${{ steps.process_safe_outputs.outputs.create_discussion_errors }}
      process_safe_outputs_processed_count: ${{ steps.process_safe_outputs.outputs.processed_count }}
      process_safe_outputs_temporary_id_map: ${{ steps.process_safe_outputs.outputs.temporary_id_map }}
    steps:
      - name: Setup Scripts
        uses: github/gh-aw/actions/setup@17c31ffe96b274cb4a6693638cabf61e45996ee7 # v0.40.1
        with:
          destination: /opt/gh-aw/actions
      - name: Download agent output artifact
        continue-on-error: true
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: agent-output
          path: /tmp/gh-aw/safeoutputs/
      - name: Setup agent output environment variable
        run: |
          mkdir -p /tmp/gh-aw/safeoutputs/
          find "/tmp/gh-aw/safeoutputs/" -type f -print
          echo "GH_AW_AGENT_OUTPUT=/tmp/gh-aw/safeoutputs/agent_output.json" >> "$GITHUB_ENV"
      - name: Download patch artifact
        continue-on-error: true
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: agent-artifacts
          path: /tmp/gh-aw/
      - name: Checkout repository
        if: ((!cancelled()) && (needs.agent.result != 'skipped')) && (contains(needs.agent.outputs.output_types, 'create_pull_request'))
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          token: ${{ github.token }}
          persist-credentials: false
          fetch-depth: 1
      - name: Configure Git credentials
        if: ((!cancelled()) && (needs.agent.result != 'skipped')) && (contains(needs.agent.outputs.output_types, 'create_pull_request'))
        env:
          REPO_NAME: ${{ github.repository }}
          SERVER_URL: ${{ github.server_url }}
          GIT_TOKEN: ${{ github.token }}
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          # Re-authenticate git with GitHub token
          SERVER_URL_STRIPPED="${SERVER_URL#https://}"
          git remote set-url origin "https://x-access-token:${GIT_TOKEN}@${SERVER_URL_STRIPPED}/${REPO_NAME}.git"
          echo "Git configured with standard GitHub Actions identity"
      - name: Process Safe Outputs
        id: process_safe_outputs
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          GH_AW_AGENT_OUTPUT: ${{ env.GH_AW_AGENT_OUTPUT }}
          GH_AW_SAFE_OUTPUTS_HANDLER_CONFIG: "{\"create_pull_request\":{\"base_branch\":\"${{ github.ref_name }}\",\"draft\":true,\"if_no_changes\":\"warn\",\"labels\":[\"automation\",\"tests\"],\"max\":1,\"max_patch_size\":1024,\"title_prefix\":\"[DeepTest+Coverage Ubuntu Run #${{ github.run_id }}] \"},\"missing_data\":{},\"missing_tool\":{}}"
        with:
          github-token: ${{ secrets.GH_AW_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const { setupGlobals } = require('/opt/gh-aw/actions/setup_globals.cjs');
            setupGlobals(core, github, context, exec, io);
            const { main } = require('/opt/gh-aw/actions/safe_output_handler_manager.cjs');
            await main();

